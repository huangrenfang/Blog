## 事件循环机制(Event Loop)

### 什么是事件循环机制？

> 事件循环机制是指浏览器在处理 JavaScript 代码时，使用的一种循环机制。它的作用是不断地从消息队列中取出事件，并将其分配给相应的处理程序进行处理。

### 为什么需要事件循环机制?

因为渲染进程中的只有主线程，而且主线程十分繁忙（即使用 worker 启用也是新的线程也是一样的）。  
要让不同类型的任务有条不紊地执行，就需要统筹调度。而且很多任务是在执行中产生的，所以就需要不间断地从消息队列中将任务取出，这也是事件循环机制的由来

## 消息队列

### 什么是消息队列

消息队列是存储任务的数据结构，因为他是`先进先出`的结构所以叫消息队列

### 为什么需要消息队列

`渲染主线程`会从`IO线程`中频繁接收到任务，接收到这些任务之后，渲染进程就需要着手处理，比如接收到资源加载完成的消息后，渲染进程就要着手进行 DOM 解析了；接收到鼠标点击的消息后，渲染主线程就要开始执行相应的 JavaScript 脚本来处理该点击事件.

而 JS 是单线程的，如果任务量比较大或者没有优先级执行的情况，很多任务就不会被高效和及时执行

那么如何维护好一个从各线程间获取任务和消息的设计结构，消息队列就诞生了  
这个结构需要

### 消息队列是如何实现的

#### 消息队列遇到的问题

1. 因为是单线程的原因，如果所有任务都是按队列的形式同步执行，那么很多任务就需要等待前面的任务执行完毕，如果前面的任务执行较长，后面的任务会被阻塞
2. 如果浏览器监听 DOM 变化事件触发比较频繁，后续的事件将会被放在消息队列的队尾，那么实时性将会非常差.如果是同步任务则需要每次都重新调用，影响执行效率
3. 如果遇到定时器这种需要延迟执行的任务该如何处理

#### 如何解决上述问题

1. JavaScript 可以通过回调功能来规避这种问题，也就是让要执行的 JavaScript 任务滞后执行.
2. 通过引入宏任务和微任务的概念解决

**什么是宏任务？**  
像 DOM 事件、解析文件、计算布局、用户交互事件、进程间消息通知的事件这些影响和作用返回较广的被当做宏任务

**什么是微任务？**  
微任务是需要异步执行的任务，它会在主函数执行完毕之后，在宏任务结束之前执行。相对来说执行优先级比较低没有宏任务高，但是需要在下一个宏任务之前执行，以保证在当前宏任务下的执行实时性

**怎么分工的呢？**  
每个宏任务都会维护一个微任务队列，在执行宏任务期间遇到微任务会将微任务放在微任务队列队尾。执行完当前宏任务后，再执行从微任务队列中拿出来执行，在微任务队列中还有微任务的话也会将新的微任务放在队尾。  
这样的话就可以保证类似一个 DOM 监听事件，将变化通知视作微任务，这样就解决了实时性问题和执行效率问题

3. 通过引入延迟任务队列，像定时器和一些浏览器需要延迟执行的任务都会放在里面。执行的时机为消息队列中的一个完整任务执行完毕后再执行延迟任务队列中的任务，即在后一个消息队列中的任务执行前.

clearTimeout 的实现就是获取到 ID，执行在延迟任务队列中找到 ID 并删除。

**定时器弊端：**

1. 如果消息队列中的任务执行过久，比如 JS 执行一段很长的任务，其实定时器再执行，即使设置了 0 秒的延迟
2. 未激活的页面 background tab 中的定时器执行最小间隔会被设置为 1000ms
3. 定时器存在嵌套使用时, 系统设置最小间隔为 4ms
4. 定时器存在最大时间值 2147483647 毫秒，如果大于这个值相当于设置为 0 毫秒
5. 定时器内部 this 指向问题，如果执行的函数为某个对象下的属性，执行传入定时器的话，this 指向会被当做全局上下文，而不是对象的。
